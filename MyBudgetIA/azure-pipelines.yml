trigger:
  - dev
pr:
  - master

variables:
  buildConfiguration: 'Release'
  workingDir: 'MyBudgetIA'

stages:

# ============================================================
# 1. BUILD + UNIT TESTS + CACHE NUGET
# ============================================================
- stage: Build
  displayName: "Build & Unit Tests"
  jobs:
    - job: build
      displayName: "Build .NET + Unit Tests"
      pool:
        vmImage: ubuntu-latest

      steps:

        # --- Debug workspace ---
        - script: |
            echo "Current directory:"
            pwd
            echo "Listing files:"
            ls -R
          displayName: "Debug workspace"

        # --- Cache NuGet ---
        - task: Cache@2
          inputs:
            key: 'nuget | "$(Agent.OS)" | **/*.csproj | **/global.json'
            restoreKeys: |
              nuget | "$(Agent.OS)"
            path: $(HOME)/.nuget/packages
          displayName: "Cache NuGet packages"

        # --- Install .NET SDK ---
        - task: UseDotNet@2
          inputs:
            version: '10.0.x'

        - task: UseDotNet@2 
          inputs: 
            version: '8.0.x'

        - script: dotnet --list-sdks
          displayName: 'List installed SDKs'

        # --- Restore API --- 
        - script: dotnet restore MyBudgetIA.Api/MyBudgetIA.Api.csproj
          workingDirectory: $(workingDir) 
          displayName: "Restore API" 
          
        # --- Restore Function ---
        - script: dotnet restore MyBudgetIA.InvoiceFunction/MyBudgetIA.InvoiceFunction.csproj
          workingDirectory: $(workingDir)
          displayName: "Restore Function" 

        # --- Build API---
        - script: dotnet build MyBudgetIA.Api/MyBudgetIA.Api.csproj -c $(buildConfiguration)
          workingDirectory: $(workingDir)
          displayName: "Build API"

        # --- Build Function --- 
        - script: dotnet build MyBudgetIA.InvoiceFunction/MyBudgetIA.InvoiceFunction.csproj -c $(buildConfiguration) 
          workingDirectory: $(workingDir) 
          displayName: "Build Function" 

        # --- Unit Tests ---
        - script: dotnet test --configuration $(buildConfiguration) --filter "TestCategory!=Integration"
          workingDirectory: $(workingDir)
          displayName: "Run Unit Tests"


# ============================================================
# 2. INTEGRATION TESTS (docker-compose.integration.yml)
# ============================================================
- stage: IntegrationTests
  displayName: "Integration Tests"
  dependsOn: Build
  jobs:
    - job: integration
      displayName: "Run Integration Tests"
      pool:
        vmImage: ubuntu-latest

      steps:
        - script: docker compose -f docker-compose.integration.yml up -d
          workingDirectory: $(workingDir)
          displayName: "Start integration environment"

        - script: dotnet test MyBudgetIA.Infrastructure.Tests/MyBudgetIA.Infrastructure.Tests.csproj --filter "TestCategory=Integration"
          workingDirectory: $(workingDir)
          displayName: "Run Integration Tests - Infrastructure"

        - script: dotnet test MyBudgetIA.Application.Tests/MyBudgetIA.Application.Tests.csproj --filter "TestCategory=Integration"
          workingDirectory: $(workingDir)
          displayName: "Run Integration Tests - Application"

        - script: docker compose -f docker-compose.integration.yml down
          workingDirectory: $(workingDir)
          displayName: "Cleanup"


# ============================================================
# 3. PACKAGE (BUILD DOCKER + TRIVY + ARTEFACT)
# ============================================================
- stage: Package
  displayName: "Package Docker Image"
  dependsOn: IntegrationTests
  jobs:
    - job: package
      displayName: "Build Docker Image + Scan + Publish Artifact"
      pool:
        vmImage: ubuntu-latest

      steps:
        # --- Build API image ---
        - script: docker build -t mybudgetia-api:$(Build.BuildId) -f Dockerfile . 
          workingDirectory: $(workingDir) 
          displayName: "Build Docker image (API)" 
          
        # --- Build Function image --- 
        - script: docker build -t mybudgetia-invoice-function:$(Build.BuildId) -f MyBudgetIA.InvoiceFunction/Docker/Dockerfile . 
          workingDirectory: $(workingDir) 
          displayName: "Build Docker image (Invoice Function)" 
          
        # --- Scan API image --- 
        - script: docker run --rm -v /var/run/docker.sock:/var/run/docker.sock aquasec/trivy:latest image --exit-code 1 --severity HIGH,CRITICAL mybudgetia-api:$(Build.BuildId) 
          workingDirectory: $(workingDir) 
          displayName: "Scan API image with Trivy"
          
        # --- Scan Function image --- 
        - script: docker run --rm -v /var/run/docker.sock:/var/run/docker.sock aquasec/trivy:latest image --exit-code 1 --severity HIGH,CRITICAL mybudgetia-invoice-function:$(Build.BuildId)
          workingDirectory: 
          $(workingDir) displayName: "Scan Function image with Trivy" 

        # --- Export images ---
        - script: | 
            mkdir -p $(Build.ArtifactStagingDirectory)/image 
            docker save mybudgetia-api:$(Build.BuildId) -o $(Build.ArtifactStagingDirectory)/image/mybudgetia-api.tar
            docker save mybudgetia-invoice-function:$(Build.BuildId) -o $(Build.ArtifactStagingDirectory)/image/mybudgetia-invoice-function.tar 
          workingDirectory: $(workingDir)
          displayName: "Export Docker images as tar"

        - task: PublishBuildArtifacts@1
          inputs:
            pathToPublish: "$(Build.ArtifactStagingDirectory)"
            artifactName: "drop"
          displayName: "Publish Artifact"
